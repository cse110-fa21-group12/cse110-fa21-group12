const fs = require("fs").promises,
  path = require("path"),
  Server = require("../server/server"),
  config = require("../config"),
  status = require("../server/utils/status"),
  auth = require("../auth/auth"),
  router = new Server.Router(),
  BASE_DIR = path.join(__dirname, "../../");
async function validateFile(a) {
  await fs.access(a);
  const b = await fs.stat(a);
  if (!b.isFile()) throw "Not Found";
}
router.use(
  (a, b, c) => {
    const d = path.extname(a.url);
    return !d || ".html" != d || config.noAuth.has(a.url)
      ? c()
      : void auth.verifyToken(a, b, c);
  },
  async (a, b) => {
    try {
      const c = path.join(BASE_DIR, a.url);
      await validateFile(c), b.sendFile(c);
    } catch (c) {
      b.writeHead(status.NOT_FOUND, { "Content-Type": "text/plain" }),
        b.end(`${status.NOT_FOUND} - ${a.url} not found`);
    }
  }
),
  (module.exports = { routes: router });
